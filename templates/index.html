<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Player</title>
    <link rel="stylesheet" href="/static/index.css">
    <script>
        let audioFiles = {{ audio_files|tojson|safe }}; // JSON 형식으로 audio_files 가져옴
        let currentIndex = 0; // 현재 트랙 인덱스
        let nextTrackCalled = false; // 중복 호출 방지 플래그
    
        // 배열을 섞는 함수
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
    
        shuffleArray(audioFiles); // audioFiles 배열 섞기
    
        // 트랙 정보 업데이트
        function updateTrackInfo() {
            const audioElement = document.getElementById('audio-player');
            const titleElement = document.getElementById('track-title');
            const coverElement = document.getElementById('album-cover');
            const currentTrack = audioFiles[currentIndex];
            const originalPath = currentTrack.path.replace(/\\/g, '/').split('/').pop();
            const trackName = originalPath.replace(/\.[^/.]+$/, ""); // 확장자 제거
    
            titleElement.textContent = trackName;
    
            const selectedEffects = getSelectedEffects();
            const encodedFilename = encodeURIComponent(originalPath);
    
            audioElement.src = `/audio/${encodedFilename}?effects=${selectedEffects}`;
            coverElement.src = `/cover/${encodedFilename}`;
    
            coverElement.onerror = () => {
                coverElement.src = "/public/none";
                coverElement.onerror = null;
            };
            
            
            audioElement.load();
            // 곡 종료 직전 상태 감지
            audioElement.ontimeupdate = function () {
                const remainingTime = audioElement.duration - audioElement.currentTime;
                if (remainingTime <= 1 && !nextTrackCalled) {
                    nextTrackCalled = true;
                    console.log("Audio about to end. Preparing next track...");
                    androidplaynexttrack();
                }
            };
            // 페이지 로드 시 첫 트랙 자동 재생
            audioElement.play()
                .then(() => {
                    console.log("Playback started successfully.");
                })
                .catch(error => {
                    console.error("Playback failed due to: ", error);
                });
                    // Android 메서드 호출 - 트랙 정보 업데이트 및 오디오 전송
                    if (window.Android) { //이로 인해 다음 곡으로 넘어갈 수 있음
                        console.log(`Updating track info: ${trackName}`);
                        window.Android.updateTrackInfo(trackName, coverElement.src);
                        window.Android.transferAudioData(originalPath);
                    }
                }
    
        // 선택된 효과 가져오기
        function getSelectedEffects() {
            const effects = [];
            document.querySelectorAll('input[name="effects"]:checked').forEach((checkbox) => {
                effects.push(checkbox.value);
            });
            return effects.join(',');
        }
    
        // 다음 곡으로 전환
        function nextTrack() {
            console.log("Switching to the next track...");
            currentIndex = (currentIndex + 1) % audioFiles.length;
            nextTrackCalled = false; // 플래그 초기화
            updateTrackInfo(); // 트랙 정보 업데이트
    
            const audioElement = document.getElementById("audio-player");
            audioElement.currentTime = 0;
    
            audioElement.play().catch(error => { // 재생 실패 시 오류 출력
                console.error("Playback failed due to: ", error);
            });
        }
    
        // Android와 통합된 다음 트랙 함수 호출
        function androidplaynexttrack() {
            console.log("androidplaynexttrack called");
            nextTrack();
            return "success";
        }
    
        // 이전 트랙으로 전환 함수
        function previousTrack() {
            console.log("Switching to the previous track...");
            currentIndex = (currentIndex - 1 + audioFiles.length) % audioFiles.length;
            updateTrackInfo();
    
            const audioElement = document.getElementById("audio-player");
            audioElement.currentTime = 0;
    
            audioElement.play().catch(error => {
                console.log("Playback failed due to user interaction requirements. Error: ", error);
            });
        }
    
        // 페이지 로드 시 초기화 및 트랙 목록 생성
        window.onload = function () {
            const audioElement = document.getElementById("audio-player");
    
            if (!audioElement) {
                console.error("audio-player element not found!");
                return;
            }
    
            updateTrackInfo();
    
            // 곡 종료 직전 상태 감지
            audioElement.ontimeupdate = function () {
                const remainingTime = audioElement.duration - audioElement.currentTime;
                if (remainingTime <= 1 && !nextTrackCalled) {
                    nextTrackCalled = true;
                    console.log("Audio about to end. Preparing next track...");
                    androidplaynexttrack();
                }
            };
    
            // // 곡이 완전히 종료되었을 때 처리
            // audioElement.onended = function () {
            //     if (!nextTrackCalled) {
            //         nextTrackCalled = true;
            //         console.log("Audio ended. Calling androidplaynexttrack...");
            //         androidplaynexttrack();
            //     }
            // };
            const sidebar = document.querySelector(".sidebar-content");
            audioFiles.forEach((audio, i) => {
                const div = document.createElement('div');
                div.onclick = () => {
                    setTrack(i);
                }
                div.textContent = audio.name;
                div.className = "sidebar-track";
                sidebar.appendChild(div);
            })

        };
    </script>    
</head>

<body>
    <div class="title"><h1>Audio Player with Effects</h1></div>
    <div class="main">
        <div class="content">
            <div class="player">
                <h3 id="track-title"></h3>
                <img id="album-cover" src="default_cover.png" alt="Album Cover" width="300" height="300" />
                <div class="special-controls">
                    <h4>Select Effects:</h4>
                    <label><input type="checkbox" name="effects" value="echo"> Echo</label><br>
                    <label><input type="checkbox" name="effects" value="reverb"> Reverb</label><br>
                </div>
                <audio id="audio-player" controls>
                    <source id="audio-source" src="" type="audio/flac">
                    Your browser does not support the audio element.
                </audio>
            </div>
        
            <div class="buttons">
                <button onclick="previousTrack()">Previous Track</button>
                <button onclick="nextTrack()">Next Track</button>
            </div>
        </div>

        <div class="sidebar">
            <div class="sidebar-content">
            </div>
        </div>
    </div>
</body>

</html>
