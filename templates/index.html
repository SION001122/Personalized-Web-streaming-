<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Audio Player</title>
  <link rel="stylesheet" href="/static/index.css">
  <style>
    .sidebar {
      width: 300px;
      height: 600px; /* 스크롤 테스트용 고정 높이 */
      overflow-y: auto;
      border: 1px solid #ccc;
      -webkit-overflow-scrolling: touch; /* iOS 스크롤 부드럽게 */
    }
    .sidebar-content {
      position: relative;
      width: 100%;
    }
    .sidebar-track {
      height: 30px;
      line-height: 30px;
      padding: 0 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      background: #fff; /* 겹침 방지 */
    }
    .sidebar-album {
      height: 30px;
      line-height: 30px;
      font-weight: bold;
      background: #f0f0f0;
      padding: 0 10px;
    }
    /* 오디오 플레이어 컨트롤 크기 */
    #audio-player {
      margin-top: 10px;
      width: 250px;
      height: 40px;
    }
  </style>
  <script>
    const basename = (p) => p.split(/[/\\]/).pop();
    const stripExt = (name) => name.replace(/\.[^.]+$/, "");

    let albumData = {};
    let searchIndex = [];
    let albumKeys = [];
    let currentAlbumIndex = 0;
    let currentTrackIndex = 0;
    let audioDuration = 0;

    // Virtual scroll
    let flatTrackList = [];
    const ITEM_HEIGHT = 30;
    const VISIBLE_COUNT = 40;
    let totalHeight = 0;

    // iOS 감지
    function isIOS() {
      return /iPad|iPhone|iPod/.test(navigator.userAgent);
    }

    function trackTimeUpdate() {
      const audioElement = document.getElementById('audio-player');
      if (audioElement.currentTime >= audioElement.duration - 1) {
        console.log("트랙 종료 감지 -> 다음 곡으로 이동");
        nextTrack();
      }
    }

    async function fetchAlbumData() {
      const response = await fetch('/albums_list');
      albumData = await response.json();
      albumKeys = Object.keys(albumData);
      createSearchIndex(albumData);
      buildFlatTrackList(albumData);
      renderVirtualSidebar();
      updateTrackInfo();
    }

    function buildFlatTrackList(data) {
      flatTrackList = [];
      Object.keys(data).forEach(albumKey => {
        flatTrackList.push({ type: "album", name: albumKey });
        data[albumKey].forEach(track => {
          flatTrackList.push({ type: "track", album: albumKey, track });
        });
      });
      totalHeight = flatTrackList.length * ITEM_HEIGHT;
    }

    function createSearchIndex(data) {
      searchIndex = [];
      Object.keys(data).forEach(albumKey => {
        data[albumKey].forEach(track => {
          searchIndex.push({
            album: albumKey.toLowerCase(),
            track: track.name.toLowerCase(),
            path: track.path
          });
        });
      });
    }

    function searchTracks() {
      const query = document.getElementById('search-bar').value.toLowerCase();
      const filteredTracks = searchIndex.filter(item =>
        item.album.includes(query) || item.track.includes(query)
      );
      const filteredData = {};
      filteredTracks.forEach(item => {
        if (!filteredData[item.album]) filteredData[item.album] = [];
        filteredData[item.album].push({ name: item.track, path: item.path });
      });
      buildFlatTrackList(filteredData);
      renderVirtualSidebar();
    }

    function renderVirtualSidebar() {
      const sidebar = document.querySelector('.sidebar');
      const content = document.querySelector('.sidebar-content');
      content.style.height = totalHeight + "px";

      function render() {
        const scrollTop = sidebar.scrollTop;
        const startIndex = Math.floor(scrollTop / ITEM_HEIGHT);
        const endIndex = Math.min(startIndex + VISIBLE_COUNT, flatTrackList.length);

        content.innerHTML = "";
        for (let i = startIndex; i < endIndex; i++) {
          const item = flatTrackList[i];
          const div = document.createElement("div");
          div.style.height = ITEM_HEIGHT + "px";
          div.style.lineHeight = ITEM_HEIGHT + "px";
          div.style.transform = `translateY(${i * ITEM_HEIGHT}px)`;

          if (item.type === "album") {
            div.className = "sidebar-album";
            div.textContent = item.name;
          } else {
            div.className = "sidebar-track";
            div.textContent = item.track.name;
            div.onclick = () => playTrackByPath(item.track.path);
          }
          content.appendChild(div);
        }
      }
      sidebar.onscroll = render;
      render();
    }

    function playTrackByPath(path) {
      const foundTrack = findTrackByPath(path);
      if (foundTrack) {
        const { albumKey, trackIndex } = foundTrack;
        currentAlbumIndex = albumKeys.indexOf(albumKey);
        currentTrackIndex = trackIndex;
        updateTrackInfo();
      } else {
        console.error(`Track with path "${path}" not found in albumData.`);
      }
    }

    function findTrackByPath(path) {
      for (const albumKey of albumKeys) {
        const trackIndex = albumData[albumKey].findIndex((track) => track.path === path);
        if (trackIndex !== -1) {
          return { albumKey, trackIndex };
        }
      }
      return null;
    }

    async function fetchAudioDuration(path) {
      try {
        const filename = basename(path);
        const res = await fetch(`/audio/duration/${encodeURIComponent(filename)}`);
        if (!res.ok) throw new Error('Failed to fetch audio duration');
        const { duration } = await res.json();
        return Math.floor(duration - 2);
      } catch (e) {
        console.error("fetchAudioDuration 오류:", e);
        return 10;
      }
    }

    async function updateTrackInfo() {
      const audioElement = document.getElementById('audio-player');
      const titleElement = document.getElementById('track-title');
      const coverElement = document.getElementById('album-cover');

      const currentAlbum = albumKeys[currentAlbumIndex];
      const currentTrack = albumData[currentAlbum][currentTrackIndex];

      const fileWithExt = basename(currentTrack.path);
      const encoded = encodeURIComponent(fileWithExt);
      const displayName = stripExt(fileWithExt);

      audioElement.removeEventListener("timeupdate", trackTimeUpdate);
      audioElement.removeEventListener("ended", nextTrack);

      titleElement.textContent = displayName;
      audioElement.src = `/audio/${encoded}`;
      coverElement.src = `/cover/${encoded}`;
      coverElement.onerror = () => {
        coverElement.src = '/public/none';
        coverElement.onerror = null;
      };

      try {
        audioDuration = await fetchAudioDuration(currentTrack.path);
        audioElement.addEventListener("timeupdate", trackTimeUpdate);
        audioElement.addEventListener("ended", nextTrack);

        audioElement.load();
        audioElement.addEventListener('canplay', () => {
          audioElement.play().catch(err => {
            console.warn("iOS에서 자동 재생 실패, 사용자 입력 필요:", err);
          });
        }, { once: true });
      } catch (err) {
        console.error("오류 발생:", err);
      }
    }

    function nextTrack() {
      const audioElement = document.getElementById("audio-player");
      const currentAlbum = albumKeys[currentAlbumIndex];
      if (currentTrackIndex + 1 < albumData[currentAlbum].length) {
        currentTrackIndex++;
      } else if (currentAlbumIndex + 1 < albumKeys.length) {
        currentAlbumIndex++;
        currentTrackIndex = 0;
      } else {
        currentAlbumIndex = 0;
        currentTrackIndex = 0;
      }
      updateTrackInfo();
      let timeout = setTimeout(() => {
        if (audioElement.paused) {
          console.log("3초 동안 재생되지 않음 → 다음 트랙으로 이동");
          nextTrack();
        }
      }, 3000);
      audioElement.addEventListener("playing", () => clearTimeout(timeout), { once: true });
    }

    function previousTrack() {
      if (currentTrackIndex > 0) {
        currentTrackIndex--;
      } else if (currentAlbumIndex > 0) {
        currentAlbumIndex--;
        const prevAlbum = albumKeys[currentAlbumIndex];
        currentTrackIndex = albumData[prevAlbum].length - 1;
      } else {
        currentAlbumIndex = albumKeys.length - 1;
        const lastAlbum = albumKeys[currentAlbumIndex];
        currentTrackIndex = albumData[lastAlbum].length - 1;
      }
      updateTrackInfo();
    }

    function playRandomTrack() {
      if (albumKeys.length === 0 || Object.keys(albumData).length === 0) return;
      const randomAlbumIndex = Math.floor(Math.random() * albumKeys.length);
      const randomTrackIndex = Math.floor(Math.random() * albumData[albumKeys[randomAlbumIndex]].length);
      currentAlbumIndex = randomAlbumIndex;
      currentTrackIndex = randomTrackIndex;
      updateTrackInfo();
    }

    window.onload = function () {
      fetchAlbumData();
      document.getElementById('search-bar').addEventListener('input', searchTracks);

      // iOS Safari 첫 터치에서 resume/play 강제
      if (isIOS()) {
        document.body.addEventListener("touchend", async () => {
          const audioElement = document.getElementById("audio-player");
          try {
            await audioElement.play();
            console.log("iOS Safari 재생 성공");
          } catch (err) {
            console.warn("iOS Safari 재생 실패", err);
          }
        }, { once: true });
      }
    };

    if ('mediaSession' in navigator) {
      navigator.mediaSession.setActionHandler('play', () => {
        document.getElementById('audio-player').play();
      });
      navigator.mediaSession.setActionHandler('pause', () => {
        document.getElementById('audio-player').pause();
      });
      navigator.mediaSession.setActionHandler('previoustrack', previousTrack);
      navigator.mediaSession.setActionHandler('nexttrack', nextTrack);
    }
  </script>
</head>

<body>
  <div class="title"><h1>Audio Player</h1></div>
  <div class="main">
    <div class="content">
      <div class="player">
        <input type="text" id="search-bar" placeholder="Search for albums or tracks...">
        <h3 id="track-title"></h3>
        <img id="album-cover" src="/public/none" alt="Album Cover" width="300" height="300" />
        <!-- video 태그를 작게 표시 -->
        <video id="audio-player" playsinline controls></video>
        <div class="buttons">
          <button onclick="previousTrack()">Previous Track</button>
          <button onclick="nextTrack()">Next Track</button>
        </div>
      </div>
      <div class="sidebar">
        <div class="sidebar-content"></div>
      </div>
      <div class="random-play">
        <button onclick="playRandomTrack()">Random Play</button>
      </div>
    </div>
  </div>
</body>
</html>
