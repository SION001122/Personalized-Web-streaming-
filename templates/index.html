<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Player</title>
    <link rel="stylesheet" href="/static/index.css">
    <script>
            let albumData = {}; // Ïï®Î≤î Îç∞Ïù¥ÌÑ∞Î•º Ï†ÄÏû•
            let searchIndex = []; // Í≤ÄÏÉâ Ïù∏Îç±Ïä§
            let albumKeys = []; // Ïï®Î≤î ÏàúÏÑúÎ•º Ï†ÄÏû•
            let currentAlbumIndex = 0; // ÌòÑÏû¨ Ïï®Î≤î Ïù∏Îç±Ïä§
            let currentTrackIndex = 0; // ÌòÑÏû¨ Ìä∏Îûô Ïù∏Îç±Ïä§
            let audioDuration = 0; // ÌòÑÏû¨ Ìä∏Îûô Í∏∏Ïù¥ Ï†ÄÏû•

        // Ï†ÑÏó≠ `trackTimeUpdate` Ìï®Ïàò Ï†ïÏùò
        function trackTimeUpdate() {
            const audioElement = document.getElementById('audio-player');
            if (audioElement.currentTime >= audioDuration) {
                console.log("Ìä∏Îûô Ï¢ÖÎ£å Í∞êÏßÄ -> Îã§Ïùå Í≥°ÏúºÎ°ú Ïù¥Îèô");
                nextTrack();
            }
            }
        // JSON Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞
        async function fetchAlbumData() {
            const response = await fetch('/albums_list');
            albumData = await response.json();
            albumKeys = Object.keys(albumData);
            createSearchIndex(albumData); // Í≤ÄÏÉâ Ïù∏Îç±Ïä§ ÏÉùÏÑ±
            renderSidebar(); // Ï¥àÍ∏∞ ÏÉÅÌÉúÎ°ú Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ ÌëúÏãú
            updateTrackInfo();
        }


        // Í≤ÄÏÉâ Ïù∏Îç±Ïä§ ÏÉùÏÑ±
        function createSearchIndex(data) {
            searchIndex = [];
            Object.keys(data).forEach(albumKey => {
                data[albumKey].forEach(track => {
                    searchIndex.push({
                        album: albumKey.toLowerCase(),
                        track: track.name.toLowerCase(),
                        path: track.path
                    });
                });
            });
        }

        // Í≤ÄÏÉâ Í∏∞Îä•
        function searchTracks() {
            const query = document.getElementById('search-bar').value.toLowerCase();
            const filteredTracks = searchIndex.filter(item =>
                item.album.includes(query) || item.track.includes(query)
            );

            const filteredData = {};
            filteredTracks.forEach(item => {
                if (!filteredData[item.album]) filteredData[item.album] = [];
                filteredData[item.album].push({ name: item.track, path: item.path });
            });

            renderSidebar(filteredData);
        }

        // Ïä¨ÎùºÏù¥ÎçîÎ∞îÏóê Ïï®Î≤îÍ≥º Ìä∏Îûô ÌëúÏãú
        function renderSidebar(filteredData = null) {
            const sidebar = document.querySelector('.sidebar-content');
            sidebar.innerHTML = ''; // Í∏∞Ï°¥ ÎÇ¥Ïö© Ï¥àÍ∏∞Ìôî
            const data = filteredData || albumData;

            Object.keys(data).forEach((albumKey) => {
                // Ïï®Î≤î Ìó§Îçî
                const albumHeader = document.createElement('div');
                albumHeader.textContent = albumKey;
                albumHeader.className = 'sidebar-album';
                sidebar.appendChild(albumHeader);

                // Ìä∏Îûô Î¶¨Ïä§Ìä∏
                data[albumKey].forEach((track) => {
                    const trackDiv = document.createElement('div');
                    trackDiv.textContent = track.name;
                    trackDiv.className = 'sidebar-track';
                    trackDiv.onclick = () => {
                        playTrackByPath(track.path); // Í≤ΩÎ°úÎ•º Í∏∞Î∞òÏúºÎ°ú Í≥° Ïû¨ÏÉù
                    };
                    sidebar.appendChild(trackDiv);
                });
            });
        }

        // Í≤ΩÎ°ú Í∏∞Î∞òÏúºÎ°ú Í≥° Ïû¨ÏÉù
        function playTrackByPath(path) {
            const foundTrack = findTrackByPath(path);
            if (foundTrack) {
                const { albumKey, trackIndex } = foundTrack;
                currentAlbumIndex = albumKeys.indexOf(albumKey);
                currentTrackIndex = trackIndex;
                updateTrackInfo();
            } else {
                console.error(`Track with path "${path}" not found in albumData.`);
            }
        }

        // Í≤ΩÎ°ú Í∏∞Î∞òÏúºÎ°ú Ìä∏Îûô Ï∞æÍ∏∞
        function findTrackByPath(path) {
            for (const albumKey of albumKeys) {
                const trackIndex = albumData[albumKey].findIndex((track) => track.path === path);
                if (trackIndex !== -1) {
                    return { albumKey, trackIndex };
                }
            }
            return null;
        }

        // Ïò§ÎîîÏò§ Í∏∏Ïù¥ Í∞ÄÏ†∏Ïò§Í∏∞ (Ï∫êÏã± Ï†úÍ±∞)
        async function fetchAudioDuration(path) {
            try {
                const response = await fetch(`/audio/duration/${encodeURIComponent(path.split('\\').pop())}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch audio duration');
                }
                const { duration } = await response.json();
                return duration;
            } catch (error) {
                console.error(error);
                return 0;
            }
        }


        async function updateTrackInfo() {
            const audioElement = document.getElementById('audio-player');
            const titleElement = document.getElementById('track-title');
            const coverElement = document.getElementById('album-cover');

            const currentAlbum = albumKeys[currentAlbumIndex];
            const currentTrack = albumData[currentAlbum][currentTrackIndex];
            const encodedFilename = encodeURIComponent(currentTrack.path.split('\\').pop());

            // Í∏∞Ï°¥ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï†úÍ±∞
            audioElement.removeEventListener("timeupdate", trackTimeUpdate);
            audioElement.removeEventListener("ended", nextTrack);

            // UI ÏóÖÎç∞Ïù¥Ìä∏
            titleElement.textContent = `${currentTrack.name}`;
            audioElement.src = `/audio/${encodedFilename}`;
            coverElement.src = `/cover/${encodedFilename}`;
            coverElement.onerror = () => {
                coverElement.src = '/public/none';
                coverElement.onerror = null;
            };

            try {
                // ÏÉàÎ°úÏö¥ Í≥°Ïùò Í∏∏Ïù¥Î•º Í∞ÄÏ†∏Ïò§Í∏∞
                audioDuration = await fetchAudioDuration(currentTrack.path);
                console.log("üîπ ÏÉàÎ°úÏö¥ Ìä∏Îûô Í∏∏Ïù¥ (Ï¥à):", audioDuration);

                // ÏÉà Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
                audioElement.addEventListener("timeupdate", trackTimeUpdate);
                audioElement.addEventListener("ended", nextTrack);

                // Ïò§ÎîîÏò§ Î°úÎìú Î∞è Ïû¨ÏÉù
                audioElement.load();
                audioElement.addEventListener('canplay', () => {
                    audioElement.play().catch(error => {
                        console.error("Playback failed:", error);
                    });
                }, { once: true });
            } catch (error) {
                console.error("Ïò§Î•ò Î∞úÏÉù:", error);
            }
        }

// Ïò§ÎîîÏò§ Í∏∏Ïù¥ Í∞ÄÏ†∏Ïò§Í∏∞ (ÏÑúÎ≤Ñ Ïò§Î•ò Î∞úÏÉù Ïãú Í∏∞Î≥∏Í∞í Ï†úÍ≥µ)
        async function fetchAudioDuration(path) {
            try {
                const response = await fetch(`/audio/duration/${encodeURIComponent(path.split('\\').pop())}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch audio duration');
                }
                const { duration } = await response.json();
                return duration;
            } catch (error) {
                console.error("fetchAudioDuration Ïò§Î•ò:", error);
                return 10;  // ÏÑúÎ≤Ñ Ïò§Î•ò Î∞úÏÉù Ïãú Í∏∞Î≥∏Í∞í (10Ï¥à) Ï†úÍ≥µ
            }
        }




        // Îã§Ïùå Ìä∏Îûô
        function nextTrack() {
            const currentAlbum = albumKeys[currentAlbumIndex];
            if (currentTrackIndex + 1 < albumData[currentAlbum].length) {
                currentTrackIndex++;
            } else if (currentAlbumIndex + 1 < albumKeys.length) {
                currentAlbumIndex++;
                currentTrackIndex = 0;
            } else {
                currentAlbumIndex = 0;
                currentTrackIndex = 0;
            }
            updateTrackInfo();
        }

        // Ïù¥Ï†Ñ Ìä∏Îûô
        function previousTrack() {
            if (currentTrackIndex > 0) {
                currentTrackIndex--;
            } else if (currentAlbumIndex > 0) {
                currentAlbumIndex--;
                const prevAlbum = albumKeys[currentAlbumIndex];
                currentTrackIndex = albumData[prevAlbum].length - 1;
            } else {
                currentAlbumIndex = albumKeys.length - 1;
                const lastAlbum = albumKeys[currentAlbumIndex];
                currentTrackIndex = albumData[lastAlbum].length - 1;
            }
            updateTrackInfo();
        }
        window.onload = function () {
            fetchAlbumData(); // Ïï®Î≤î Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
            document.getElementById('search-bar').addEventListener('input', searchTracks);
        };

        function playRandomTrack() {
            if (albumKeys.length === 0 || Object.keys(albumData).length === 0) {
                console.error("Album data is not loaded yet.");
                return;
            }
            const randomAlbumIndex = Math.floor(Math.random() * albumKeys.length);
            const randomTrackIndex = Math.floor(Math.random() * albumData[albumKeys[randomAlbumIndex]].length);
            currentAlbumIndex = randomAlbumIndex;
            currentTrackIndex = randomTrackIndex;
            updateTrackInfo();
        }
    </script>
</head>

<body>
    <div class="title"><h1>Audio Player</h1></div>
    <div class="main">
        <div class="content">
            <div class="player">
                <input type="text" id="search-bar" placeholder="Search for albums or tracks...">
                <h3 id="track-title"></h3> <!-- Í≥°Î™Ö ÌëúÏãú -->
                <img id="album-cover" src="/public/none" alt="Album Cover" width="300" height="300" />
                <audio id="audio-player" controls>
                    <source id="audio-source" src="" type="audio/flac">
                    Your browser does not support the audio element.
                </audio>
                <div class="buttons">
                    <button onclick="previousTrack()">Previous Track</button>
                    <button onclick="nextTrack()">Next Track</button>
                </div>
            </div>
            <div class="sidebar">
                <div class="sidebar-content">
                </div>
            </div>
            <div class ="random-play">
                <button onclick="playRandomTrack()">Random Play</button>
        </div>
    </div>
</body>

</html>
